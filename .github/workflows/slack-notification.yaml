name: Slack Notification

on:
  # Trigger when a commit is pushed to any branch
  push:
    branches: ['**']
  
  # Trigger when a PR is merged to main/master
  pull_request:
    branches: [main, master]
    types: [closed]
  
  # Trigger when other workflows complete
  workflow_run:
    workflows: ["Sync to Hugging Face Hub", "Check file size"]
    types: [completed]

jobs:
  notify-on-push:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get diff summary
        id: diff
        run: |
          # Get the list of changed files
          FILES=$(git diff --name-status HEAD~1 HEAD 2>/dev/null | head -10)
          
          # Format for Slack (A=Added, M=Modified, D=Deleted)
          FORMATTED=""
          while IFS=$'\t' read -r status file; do
            case $status in
              A) FORMATTED="${FORMATTED}+ ${file}, " ;;
              M) FORMATTED="${FORMATTED}~ ${file}, " ;;
              D) FORMATTED="${FORMATTED}- ${file}, " ;;
              R*) FORMATTED="${FORMATTED}> ${file}, " ;;
              *) FORMATTED="${FORMATTED}${file}, " ;;
            esac
          done <<< "$FILES"
          
          # Remove trailing comma and space
          FORMATTED="${FORMATTED%, }"
          
          # Count total files changed
          TOTAL=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | wc -l | tr -d ' ')
          
          # Add note if truncated
          if [ "$TOTAL" -gt 10 ]; then
            FORMATTED="${FORMATTED} ...and $((TOTAL - 10)) more"
          fi
          
          # Get stats (insertions/deletions)
          STATS=$(git diff --shortstat HEAD~1 HEAD 2>/dev/null | sed 's/^ //')
          
          # Escape for GitHub Actions output
          echo "files=${FORMATTED}" >> $GITHUB_OUTPUT
          echo "stats=${STATS}" >> $GITHUB_OUTPUT
          echo "total=${TOTAL}" >> $GITHUB_OUTPUT

      - name: Send Slack notification for push
        uses: slackapi/slack-github-action@v1.26.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload-file-path-resolved: false
          payload: >
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "New Commit Pushed",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Pushed by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ github.sha }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ toJson(format('*Message:*\n{0}', github.event.head_commit.message)) }}
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Files Changed (${{ steps.diff.outputs.total }}):*\n${{ steps.diff.outputs.files }}"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "${{ steps.diff.outputs.stats }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Commit"
                      },
                      "url": "${{ github.event.head_commit.url }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Diff"
                      },
                      "url": "${{ github.event.compare }}"
                    }
                  ]
                }
              ]
            }

  notify-on-merge:
    # Only run if the PR was actually merged (not just closed)
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Get PR files changed
        id: pr_files
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 10
            });
            
            let formatted = '';
            for (const file of files) {
              let prefix = '~';
              if (file.status === 'added') prefix = '+';
              else if (file.status === 'removed') prefix = '-';
              else if (file.status === 'renamed') prefix = '>';
              
              formatted += `${prefix} ${file.filename} (+${file.additions}/-${file.deletions}), `;
            }
            
            // Remove trailing comma and space
            formatted = formatted.slice(0, -2);
            
            const totalFiles = context.payload.pull_request.changed_files;
            if (totalFiles > 10) {
              formatted += ` ...and ${totalFiles - 10} more`;
            }
            
            core.setOutput('files', formatted);
            core.setOutput('total', totalFiles);

      - name: Send Slack notification for PR merge
        uses: slackapi/slack-github-action@v1.26.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload: >
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Pull Request Merged",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ toJson(format('*#{0} - {1}*', github.event.pull_request.number, github.event.pull_request.title)) }}
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Merged by:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.event.pull_request.head.ref }} -> ${{ github.event.pull_request.base.ref }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.event.pull_request.user.login }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Files Changed (${{ steps.pr_files.outputs.total }}):*\n${{ steps.pr_files.outputs.files }}"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "+${{ github.event.pull_request.additions }} additions, -${{ github.event.pull_request.deletions }} deletions across ${{ github.event.pull_request.commits }} commit(s)"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Pull Request"
                      },
                      "url": "${{ github.event.pull_request.html_url }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Diff"
                      },
                      "url": "${{ github.event.pull_request.html_url }}/files"
                    }
                  ]
                }
              ]
            }

  notify-on-workflow-complete:
    if: github.event_name == 'workflow_run'
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification for workflow completion
        uses: slackapi/slack-github-action@v1.26.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload: >
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ github.event.workflow_run.name }} ${{ github.event.workflow_run.conclusion == 'success' && 'Succeeded' || 'Failed' }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.event.workflow_run.head_branch }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:*\n${{ github.event.workflow_run.actor.login }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Run:*\n#${{ github.event.workflow_run.run_number }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow Run"
                      },
                      "url": "${{ github.event.workflow_run.html_url }}"
                    }
                  ]
                }
              ]
            }
