name: Slack Notification

on:
  # Trigger when a PR is merged to main/master
  pull_request:
    branches: [main, master]
    types: [closed]
  
  # Trigger when other workflows complete
  workflow_run:
    workflows: ["Sync to Hugging Face Hub", "Check file size"]
    types: [completed]

jobs:
  notify-on-merge:
    # Only run if the PR was actually merged (not just closed)
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Get PR files changed
        id: pr_files
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 10
            });
            
            let formatted = '';
            for (const file of files) {
              let prefix = '~';
              if (file.status === 'added') prefix = '+';
              else if (file.status === 'removed') prefix = '-';
              else if (file.status === 'renamed') prefix = '>';
              
              formatted += `${prefix} ${file.filename} (+${file.additions}/-${file.deletions}), `;
            }
            
            // Remove trailing comma and space
            formatted = formatted.slice(0, -2);
            
            const totalFiles = context.payload.pull_request.changed_files;
            if (totalFiles > 10) {
              formatted += ` ...and ${totalFiles - 10} more`;
            }
            
            core.setOutput('files', formatted);
            core.setOutput('total', totalFiles);

      - name: Send Slack notification for PR merge
        uses: slackapi/slack-github-action@v1.26.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload: >
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Pull Request Merged",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ toJson(format('*#{0} - {1}*', github.event.pull_request.number, github.event.pull_request.title)) }}
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Merged by:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.event.pull_request.head.ref }} -> ${{ github.event.pull_request.base.ref }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.event.pull_request.user.login }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Files Changed (${{ steps.pr_files.outputs.total }}):*\n${{ steps.pr_files.outputs.files }}"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "+${{ github.event.pull_request.additions }} additions, -${{ github.event.pull_request.deletions }} deletions across ${{ github.event.pull_request.commits }} commit(s)"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Pull Request"
                      },
                      "url": "${{ github.event.pull_request.html_url }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Diff"
                      },
                      "url": "${{ github.event.pull_request.html_url }}/files"
                    }
                  ]
                }
              ]
            }

  notify-on-workflow-complete:
    if: github.event_name == 'workflow_run'
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification for workflow completion
        uses: slackapi/slack-github-action@v1.26.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload: >
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ github.event.workflow_run.name }} ${{ github.event.workflow_run.conclusion == 'success' && 'Succeeded' || 'Failed' }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.event.workflow_run.head_branch }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:*\n${{ github.event.workflow_run.actor.login }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Run:*\n#${{ github.event.workflow_run.run_number }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow Run"
                      },
                      "url": "${{ github.event.workflow_run.html_url }}"
                    }
                  ]
                }
              ]
            }
